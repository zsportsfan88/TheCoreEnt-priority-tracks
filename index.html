<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Core Entertainment - Priority Tracks</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { 
            --gold: #C5A059; --gold-grad: linear-gradient(145deg, #f3d082, #a17d3a);
            --bg: #000; --sidebar: #0f0f0f; --border: #222; --text: #fff; --muted: #888; 
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        aside { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 30px 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand-logo { cursor: pointer; font-size: 1.4rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; background: var(--gold-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; border-bottom: 2px solid #a17d3a; padding-bottom: 15px; margin-bottom: 25px; }
        .nav-scroll { flex: 1; overflow-y: auto; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px 15px; cursor: pointer; border-radius: 4px; font-size: 0.85rem; color: var(--muted); transition: 0.2s; }
        li:hover { color: #fff; background: #1a1a1a; }
        li.active { color: #fff; border: 1px solid var(--gold); background: #111; font-weight: bold; }
        
        /* Main Header & Search */
        main { flex: 1; display: flex; flex-direction: column; background: #050505; min-width: 0; }
        .header { padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .header-controls { display: flex; align-items: center; gap: 20px; }
        
        #search-bar { background: #111; border: 1px solid var(--gold); color: #fff; padding: 10px 15px; border-radius: 6px; width: 250px; outline: none; }
        
        .toggle-container { display: flex; background: #111; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .toggle-btn { padding: 8px 16px; border: none; background: transparent; color: var(--muted); border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: bold; transition: 0.3s; }
        .toggle-btn.active { background: var(--gold-grad); color: #000; }

        /* Table */
        .content { padding: 20px 40px; overflow: hidden; flex: 1; display: flex; flex-direction: column; }
        .table-wrapper { width: 100%; overflow: auto; border: 1px solid var(--border); background: #0a0a0a; border-radius: 8px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1850px; }
        th { text-align: left; padding: 15px; color: var(--gold); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1.5px; position: sticky; top: 0; background: #050505; z-index: 20; border-bottom: 2px solid var(--border); }
        td { padding: 15px; background: #0f0f0f; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .sticky-col { position: sticky; left: 0; z-index: 10; background: #0f0f0f !important; border-right: 2px solid var(--border); }
        .heat-cell { color: #000 !important; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

<aside>
    <div class="brand-logo" onclick="location.reload()">THE CORE</div>
    <div class="nav-scroll"><ul id="artist-list"></ul></div>
</aside>

<main>
    <div class="header">
        <h2 id="view-title" style="margin:0;">Priority Tracks</h2>
        <div class="header-controls">
            <input type="text" id="search-bar" placeholder="Search song title..." oninput="renderTable()">
            <div class="toggle-container">
                <button id="btn-released" class="toggle-btn active" onclick="setMode('released')">RELEASED</button>
                <button id="btn-unreleased" class="toggle-btn" onclick="setMode('unreleased')">UNRELEASED</button>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="table-wrapper"><div id="table-output"></div></div>
    </div>
</main>

<script>
const MASTER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-yQVU_VNNOR5aXQ7m-Xv7BiAgYKjBfJuT6lIETy6ksjqR-Lj2WW4DNqYGCNX2rfCpUtemiS1shes/pub?gid=2070907343&single=true&output=csv';

const PRIORITY_ARTISTS = ["Anna Graves", "Bailey Zimmerman", "Baylee Lynn", "Brandon Wisham", "Cameron Whitcomb", "Dan + Shay", "Danielle Bradbery", "Dax", "Deltona", "Hannah McFarland", "Josh Ross", "Just Jayne", "Nate Smith"];
const EXCLUDED_SONGS = ["Jaded Songbirds", "Woman Like That", "Nothin' Left To Burn", "Other Side of Lonely", "Leave The Leavin'", "Leave The Country", "Sleeve"];
const KEEP_THESE = ["Lonely Dirt Road", "Called It", "Foolin'", "Single Again", "Fix What You Didn't Break"];

let allMasterData = [];
let currentArtistFilter = null;
let currentMode = 'released';

const parseNum = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;

function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + mode).classList.add('active');
    renderTable();
}

function getFixedHeat(val, good, bad) {
    let n = parseNum(val);
    if (n >= good) return 'background: #1DB954;';
    if (n <= bad) return 'background: #ff4444;';
    return 'background: #fff;';
}

function getRelativeHeat(val, min, max) {
    let n = parseNum(val);
    if (n === 0 && min === 0) return 'background: #333; color: #fff !important;';
    if (min === max) return 'background: #fff;'; 
    const ratio = (n - min) / (max - min || 1);
    let r, g, b = 255;
    if (ratio < 0.5) {
        let factor = ratio * 2;
        r = 255; g = Math.floor(factor * 255); b = Math.floor(factor * 255);
    } else {
        let factor = (ratio - 0.5) * 2;
        r = Math.floor((1 - factor) * 255); g = 255; b = Math.floor((1 - factor) * 255);
    }
    return `background: rgb(${r},${g},${b});`;
}

function renderTable() {
    const searchTerm = document.getElementById('search-bar').value.toLowerCase();
    const today = new Date();

    let visibleSongs = allMasterData.filter(row => {
        const artist = (row[0] || "").trim();
        const song = (row[1] || "").trim();
        const dateStr = (row[3] || "");
        const releaseDate = new Date(dateStr);
        
        // Basic Roster & Blacklist
        if (!PRIORITY_ARTISTS.includes(artist)) return false;
        if (EXCLUDED_SONGS.some(ex => song.includes(ex))) return false;
        if (artist === "Hannah McFarland" && !KEEP_THESE.includes(song)) return false;
        
        // Legacy Filter
        const isLegacy = dateStr.includes("2024") || dateStr.includes("2023");
        if (isLegacy && !KEEP_THESE.some(k => song.includes(k))) return false;

        // Released/Unreleased Mode
        if (currentMode === 'released' && releaseDate > today) return false;
        if (currentMode === 'unreleased' && releaseDate <= today) return false;

        // Sidebar Artist Filter
        const artistMatch = currentArtistFilter ? artist === currentArtistFilter : true;
        // Search bar filter
        const searchMatch = song.toLowerCase().includes(searchTerm);

        return artistMatch && searchMatch;
    });

    const globalUGC = { 
        min: Math.min(...visibleSongs.map(r => parseNum(r[36]))), 
        max: Math.max(...visibleSongs.map(r => parseNum(r[36]))) 
    };

    let html = `<table><thead><tr>
        <th class="sticky-col">Song</th><th>Artist</th><th>Rel Date</th>
        <th class="col-stat">Pre Posts</th><th class="col-stat">Post Posts</th><th class="col-stat">Total Posts</th>
        <th class="col-stat">1st Wk Str</th><th class="col-stat">Avg Wk Str</th><th class="col-stat">Total UGC</th>
    </tr></thead><tbody>`;

    visibleSongs.forEach(row => {
        const artistVisible = visibleSongs.filter(r => (r[0] || "").trim() === (row[0] || "").trim());
        const artist1stWk = { min: Math.min(...artistVisible.map(r => parseNum(r[6]))), max: Math.max(...artistVisible.map(r => parseNum(r[6]))) };
        const artistAvgWk = { min: Math.min(...artistVisible.map(r => parseNum(r[9]))), max: Math.max(...artistVisible.map(r => parseNum(r[9]))) };

        html += `<tr>
            <td class="sticky-col" style="font-weight:bold;">${row[1]}</td>
            <td style="font-size:11px; color:#888;">${row[0]}</td>
            <td style="font-weight:bold; color:var(--gold);">${row[3]}</td>
            <td class="heat-cell" style="${getFixedHeat(row[40], 20, 10)}">${row[40] || '0'}</td>
            <td class="heat-cell" style="${getFixedHeat(row[41], 25, 10)}">${row[41] || '0'}</td>
            <td class="heat-cell" style="${getFixedHeat(row[42], 40, 20)}">${row[42] || '0'}</td>
            <td class="heat-cell" style="${getRelativeHeat(row[6], artist1stWk.min, artist1stWk.max)}">${row[6] || '0'}</td>
            <td class="heat-cell" style="${getRelativeHeat(row[9], artistAvgWk.min, artistAvgWk.max)}">${row[9] || '0'}</td>
            <td class="heat-cell" style="${getRelativeHeat(row[36], globalUGC.min, globalUGC.max)}">${row[36] || '0'}</td>
        </tr>`;
    });
    document.getElementById('table-output').innerHTML = html + `</tbody></table>`;
}

function init() {
    Papa.parse(MASTER_CSV_URL, {
        download: true, header: false,
        complete: (results) => {
            allMasterData = results.data.filter(r => r[0] && r[0] !== "ARTIST");
            const list = document.getElementById('artist-list');
            PRIORITY_ARTISTS.sort().forEach(name => {
                const li = document.createElement('li');
                li.innerText = name;
                li.onclick = () => {
                    document.querySelectorAll('li').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                    currentArtistFilter = name;
                    document.getElementById('view-title').innerText = name;
                    renderTable();
                };
                list.appendChild(li);
            });
            renderTable();
        }
    });
}
init();
</script>
</body>
</html>
