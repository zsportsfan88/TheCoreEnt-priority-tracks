<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Core Entertainment - Priority Tracks</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { 
            --gold: #C5A059; --gold-grad: linear-gradient(145deg, #f3d082, #a17d3a);
            --bg: #000; --sidebar: #0f0f0f; --border: #222; --text: #fff; --muted: #888; 
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        aside { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 30px 20px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand-logo { cursor: pointer; font-size: 1.4rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; background: var(--gold-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; border-bottom: 2px solid #a17d3a; padding-bottom: 15px; margin-bottom: 25px; }
        .nav-scroll { flex: 1; overflow-y: auto; }
        ul { list-style: none; padding: 0; }
        li { padding: 10px 15px; cursor: pointer; border-radius: 4px; font-size: 0.85rem; color: var(--muted); transition: 0.2s; }
        li:hover { color: #fff; background: #1a1a1a; }
        li.active { color: #fff; border: 1px solid var(--gold); background: #111; font-weight: bold; }
        main { flex: 1; display: flex; flex-direction: column; background: #050505; min-width: 0; }
        .header { padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        #search-bar { background: #111; border: 1px solid var(--gold); color: #fff; padding: 10px 15px; border-radius: 6px; width: 250px; outline: none; }
        .toggle-container { display: flex; background: #111; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .toggle-btn { padding: 8px 16px; border: none; background: transparent; color: var(--muted); border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: bold; }
        .toggle-btn.active { background: var(--gold-grad); color: #000; }
        .content { padding: 20px 40px; overflow: hidden; flex: 1; display: flex; flex-direction: column; }
        .table-wrapper { width: 100%; overflow: auto; border: 1px solid var(--border); background: #0a0a0a; border-radius: 8px; position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 2500px; }
        th { position: sticky; top: 0; z-index: 30; background: #050505; color: var(--gold); padding: 15px; font-size: 0.65rem; text-transform: uppercase; border-bottom: 2px solid var(--border); text-align: left; }
        .sticky-col-1 { position: sticky; left: 0; z-index: 40; width: 200px; min-width: 200px; background: #0f0f0f !important; border-right: 1px solid var(--border); }
        .sticky-col-2 { position: sticky; left: 200px; z-index: 40; width: 150px; min-width: 150px; background: #0f0f0f !important; border-right: 2px solid var(--border); }
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 50; top: 0; }
        td { padding: 15px; background: #0f0f0f; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .heat-cell { color: #000 !important; font-weight: bold; text-align: center; }
        .stream-cell { color: var(--gold); font-weight: bold; cursor: help; position: relative; }
        .stream-cell:hover::after {
            content: "Last Update: " attr(data-update);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 6px 10px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; z-index: 1000; border: 1px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
<aside>
    <div class="brand-logo" onclick="location.reload()">THE CORE</div>
    <div class="nav-scroll"><ul id="artist-list"></ul></div>
</aside>
<main>
    <div class="header">
        <h2 id="view-title" style="margin:0;">Priority Tracks</h2>
        <div style="display:flex; gap:20px; align-items:center;">
            <input type="text" id="search-bar" placeholder="Search song title..." oninput="renderTable()">
            <div class="toggle-container">
                <button id="btn-released" class="toggle-btn active" onclick="setMode('released')">RELEASED</button>
                <button id="btn-unreleased" class="toggle-btn" onclick="setMode('unreleased')">UNRELEASED</button>
            </div>
        </div>
    </div>
    <div class="content"><div class="table-wrapper"><div id="table-output"></div></div></div>
</main>

<script>
const MASTER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-yQVU_VNNOR5aXQ7m-Xv7BiAgYKjBfJuT6lIETy6ksjqR-Lj2WW4DNqYGCNX2rfCpUtemiS1shes/pub?gid=2070907343&single=true&output=csv';
const PRIORITY_ARTISTS = ["Anna Graves", "Bailey Zimmerman", "Baylee Lynn", "Brandon Wisham", "Cameron Whitcomb", "Dan + Shay", "Danielle Bradbery", "Dax", "Deltona", "Hannah McFarland", "Josh Ross", "Just Jayne", "Nate Smith"];
const EXCLUDED_SONGS = ["Jaded Songbirds", "Woman Like That", "Nothin' Left To Burn", "Other Side of Lonely", "Leave The Leavin'", "Leave The Country", "Sleeve"];
const KEEP_THESE = ["Lonely Dirt Road", "Called It", "Foolin'", "Single Again", "Fix What You Didn't Break"];

let allMasterData = [];
let currentArtistFilter = null;
let currentMode = 'released';

const parseNum = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;

function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + mode).classList.add('active');
    renderTable();
}

function getTeaseHeat(teaseDateStr, relDateStr) {
    if (!teaseDateStr || !relDateStr) return 'background: #fff;';
    const t = new Date(teaseDateStr);
    const r = new Date(relDateStr);
    if (isNaN(t) || isNaN(r)) return 'background: #fff;';
    const diff = (r - t) / (1000 * 60 * 60 * 24);
    if (diff >= 20) return 'background: #1DB954;';
    if (diff < 10) return 'background: #ff4444;';
    return 'background: #fff;';
}

function getFixedHeat(val, good, bad) {
    let n = parseNum(val);
    if (n >= good) return 'background: #1DB954;';
    if (n <= bad) return 'background: #ff4444;';
    return 'background: #fff;';
}

function getRelativeHeat(val, min, max) {
    let n = parseNum(val);
    if (n === 0 && min === 0) return 'background: #333; color: #fff !important;';
    if (min === max) return 'background: #fff;'; 
    const ratio = (n - min) / (max - min || 1);
    let r, g, b = 255;
    if (ratio < 0.5) {
        let factor = ratio * 2;
        r = 255; g = Math.floor(factor * 255); b = Math.floor(factor * 255);
    } else {
        let factor = (ratio - 0.5) * 2;
        r = Math.floor((1 - factor) * 255); g = 255; b = Math.floor((1 - factor) * 255);
    }
    return `background: rgb(${r},${g},${b});`;
}

function renderTable() {
    const searchTerm = document.getElementById('search-bar').value.toLowerCase();
    const today = new Date();
    today.setHours(0,0,0,0); // Normalize today's date

    let visibleSongs = allMasterData.filter(row => {
        const artist = (row[0] || "").trim();
        const song = (row[1] || "").trim();
        const dateStr = (row[3] || "").trim();
        
        // 1. Mandatory Gate: No date, no display
        if (!dateStr || dateStr === "" || dateStr.toLowerCase().includes('tbd')) return false;

        const releaseDate = new Date(dateStr);
        if (isNaN(releaseDate)) return false;

        // 2. Roster and Blacklist
        if (!PRIORITY_ARTISTS.includes(artist)) return false;
        if (EXCLUDED_SONGS.some(ex => song.includes(ex))) return false;
        if (artist === "Hannah McFarland" && !KEEP_THESE.includes(song)) return false;
        
        // 3. Legacy Logic
        const isLegacy = dateStr.includes("2024") || dateStr.includes("2023");
        if (isLegacy && !KEEP_THESE.some(k => song.includes(k))) return false;

        // 4. Released vs Unreleased Logic
        if (currentMode === 'released' && releaseDate > today) return false;
        if (currentMode === 'unreleased' && releaseDate <= today) return false;

        // 5. Sidebar & Search
        return (currentArtistFilter ? artist === currentArtistFilter : true) && song.toLowerCase().includes(searchTerm);
    });

    const globalUGC = { 
        min: Math.min(...visibleSongs.map(r => parseNum(r[36]))), 
        max: Math.max(...visibleSongs.map(r => parseNum(r[36]))) 
    };

    let html = `<table><thead><tr>
        <th class="sticky-col-1">Song</th><th class="sticky-col-2">Artist</th>
        <th class="heat-cell">1st Tease Post</th><th>Release Date</th>
        <th class="heat-cell">Pre-Rel Artist Posts</th><th class="heat-cell">1st Wk Streams</th>
        <th class="heat-cell">Post-Rel Artist Posts</th><th>Current Streams</th>
        <th class="heat-cell">Avg Weekly Streams</th><th class="heat-cell">Total Artist Posts</th>
        <th class="heat-cell">Total UGC</th>
    </tr></thead><tbody>`;

    visibleSongs.forEach(row => {
        const artistVisible = visibleSongs.filter(r => (r[0] || "").trim() === (row[0] || "").trim());
        const artist1stWk = { min: Math.min(...artistVisible.map(r => parseNum(r[6]))), max: Math.max(...artistVisible.map(r => parseNum(r[6]))) };
        const artistAvgWk = { min: Math.min(...artistVisible.map(r => parseNum(r[9]))), max: Math.max(...artistVisible.map(r => parseNum(r[9]))) };

        html += `<tr>
            <td class="sticky-col-1" style="font-weight:bold;">${row[1]}</td>
            <td class="sticky-col-2" style="color:#888;">${row[0]}</td>
            <td class="heat-cell" style="${getTeaseHeat(row[2], row[3])}">${row[2] || '-'}</td>
            <td style="color:var(--gold); font-weight:bold;">${row[3]}</td>
            <td class="heat-cell" style="${getFixedHeat(row[40], 20, 10)}">${row[40] || '0'}</td>
            <td class="heat-cell" style="${getRelativeHeat(row[6], artist1stWk.min, artist1stWk.max)}">${row[6] || '0'}</td>
            <td class="heat-cell" style="${getFixedHeat(row[41], 20, 15)}">${row[41] || '0'}</td>
            <td class="stream-cell" data-update="${row[4] || 'N/A'}">${row[7] || '0'}</td>
            <td class="heat-cell" style="${getRelativeHeat(row[9], artistAvgWk.min, artistAvgWk.max)}">${row[9] || '0'}</td>
            <td class="heat-cell" style="${getFixedHeat(row[42], 40, 20)}">${row[42] || '0'}</td>
            <td class="heat-cell" style="${getRelativeHeat(row[36], globalUGC.min, globalUGC.max)}">${row[36] || '0'}</td>
        </tr>`;
    });
    document.getElementById('table-output').innerHTML = html + `</tbody></table>`;
}

function init() {
    Papa.parse(MASTER_CSV_URL, {
        download: true, header: false,
        complete: (results) => {
            allMasterData = results.data.filter(r => r[0] && r[0] !== "ARTIST");
            const list = document.getElementById('artist-list');
            PRIORITY_ARTISTS.sort().forEach(name => {
                const li = document.createElement('li');
                li.innerText = name;
                li.onclick = () => {
                    document.querySelectorAll('li').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                    currentArtistFilter = name;
                    document.getElementById('view-title').innerText = name;
                    renderTable();
                };
                list.appendChild(li);
            });
            renderTable();
        }
    });
}
init();
</script>
</body>
</html>
