<script>
// MASTER_CSV stays the same
const MASTER_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-yQVU_VNNOR5aXQ7m-Xv7BiAgYKjBfJuT6lIETy6ksjqR-Lj2WW4DNqYGCNX2rfCpUtemiS1shes/pub?gid=2070907343&single=true&output=csv';
const ARTISTS = ["Anna Graves", "Bailey Zimmerman", "Baylee Lynn", "Brandon Wisham", "Cameron Whitcomb", "Dan + Shay", "Danielle Bradbery", "Dax", "Deltona", "Hannah McFarland", "Josh Ross", "Just Jayne", "Nate Smith"];
const EXCLUDE = ["Clever", "Ryan Hurd"];

let allData = [];
let currentFilter = null;
let currentMode = 'released';

function setMode(m) { currentMode = m; document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+m).classList.add('active'); render(); }
function clearFilter() { currentFilter = null; document.getElementById('view-title').innerText = "Priority Tracks"; render(); }

const n = (v) => { if (!v) return 0; return parseFloat(String(v).replace(/[%,]/g,'')) || 0; };

function getHeat(val, min, max) {
    let num = n(val); if (num === 0 && min === 0) return 'background: #222; color: #666 !important;';
    const ratio = (num - min) / (max - min || 1);
    let r, g, b;
    if (ratio < 0.5) { let f = ratio * 2; r = 255; g = Math.floor(255 * f); b = Math.floor(255 * f); }
    else { let f = (ratio - 0.5) * 2; r = Math.floor(255 * (1 - f)); g = 255; b = Math.floor(255 * (1 - f)); }
    return `background: rgb(${r},${g},${b});`;
}

function getTeaseColor(teaseStr, relStr) {
    const tDate = new Date(teaseStr); const rDate = new Date(relStr);
    if (isNaN(tDate) || isNaN(rDate)) return 'text-align:center;';
    const diffDays = (rDate - tDate) / (1000 * 60 * 60 * 24);
    if (diffDays >= 20) return 'background: #1DB954; color: #000; font-weight: 900; text-align: center;';
    if (diffDays < 10) return 'background: #ff4444; color: #000; font-weight: 900; text-align: center;';
    return 'background: #fff; color: #000; font-weight: 900; text-align: center;';
}

function render() {
    const today = new Date(); today.setHours(0,0,0,0);
    let songs = allData.filter(r => {
        if (!r[1] || r[1].trim() === "") return false;
        if (EXCLUDE.includes(r[0])) return false;
        const dateStr = r[3] || "";
        const relDate = new Date(dateStr);
        const isReleased = (!isNaN(relDate) && relDate <= today);
        if (currentMode === 'released' && !isReleased) return false;
        if (currentMode === 'unreleased' && isReleased) return false;
        return currentFilter ? r[0] === currentFilter : true;
    });

    let head = `<thead><tr><th class="sticky-song">Song</th><th class="artist-cell">Artist</th><th style="width:100px">1st Song Tease</th><th style="width:100px">Release Date</th><th style="width:90px" class="date-col">Last Updated</th>`;

    if (currentMode === 'released') {
        head += `<th style="width:115px">Pre-Rel Posts/ Platform</th><th style="width:110px">1st Wk Streams</th><th style="width:115px">Post-Rel Posts/ Platform</th><th style="width:120px">Current Streams</th><th style="width:110px">Avg Weekly Streams</th><th style="width:115px">Total Posts/ Platform</th><th style="width:105px">Total UGC</th>`;
    } else {
        head += `<th style="width:115px">Pre-Rel Posts/ Platform</th><th style="width:115px">Avg Views/ Post</th><th style="width:115px">Avg Engagement Rate</th><th style="width:115px">Total UGC</th>`;
    }
    head += `</tr></thead>`;

    let body = `<tbody>`;
    songs.forEach(r => {
        const teaseStyle = getTeaseColor(r[2], r[3]);
        // Note: Indices 5 and 6 are skipped (Status and Luminate ID)
        body += `<tr><td class="sticky-song">${r[1]}</td><td class="artist-cell">${r[0]}</td><td style="${teaseStyle}">${r[2] || '-'}</td><td style="color:var(--gold); font-weight:bold; text-align:center;">${r[3] || 'TBD'}</td><td class="date-col">${r[4] || '-'}</td>`;
        
        if (currentMode === 'released') {
            // Indices shifted +2 (e.g., old 40 is now 42, old 6 is now 8)
            body += `<td class="heat-cell" style="${getHeat(r[42], 0, 40)}">${r[42] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[8], 0, 1000000)}">${r[8] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[43], 0, 40)}">${r[43] || '0'}</td>
                     <td class="stream-val">${r[9] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[11], 0, 500000)}">${r[11] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[44], 0, 80)}">${r[44] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[38], 0, 50000)}">${r[38] || '0'}</td>`;
        } else {
            // Unreleased shift
            body += `<td class="heat-cell" style="${getHeat(r[42], 0, 40)}">${r[42] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[35], 0, 250000)}">${r[35] || '0'}</td>
                     <td class="heat-cell" style="${getHeat(r[34], 0, 15)}">${r[34] || '0%'}</td>
                     <td class="heat-cell" style="${getHeat(r[38], 0, 10000)}">${r[38] || '0'}</td>`;
        }
        body += `</tr>`;
    });
    document.getElementById('table-output').innerHTML = `<table>${head}${body}</tbody></table>`;
}

Papa.parse(MASTER_CSV, {
    download: true, skipEmptyLines: true,
    complete: (res) => {
        allData = res.data.slice(1);
        const list = document.getElementById('artist-list');
        ARTISTS.sort().forEach(a => {
            let li = document.createElement('li'); li.innerText = a;
            li.onclick = () => { document.querySelectorAll('li').forEach(el=>el.classList.remove('active')); li.classList.add('active'); currentFilter = a; document.getElementById('view-title').innerText = a; render(); };
            list.appendChild(li);
        });
        render();
    }
});
</script>
