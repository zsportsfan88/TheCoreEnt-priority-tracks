<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Core Entertainment - Priority Tracks</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { 
            --gold: #C5A059; --gold-grad: linear-gradient(145deg, #f3d082, #a17d3a);
            --bg: #000; --sidebar: #0f0f0f; --border: #222; --text: #fff; --muted: #888; 
        }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 180px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 25px 10px; display: flex; flex-direction: column; flex-shrink: 0; }
        .brand-logo { cursor: pointer; font-size: 1.1rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; background: var(--gold-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; border-bottom: 2px solid #a17d3a; padding-bottom: 15px; margin-bottom: 25px; text-align: center; }
        .nav-scroll { flex: 1; overflow-y: auto; }
        ul { list-style: none; padding: 0; }
        li { padding: 8px 10px; cursor: pointer; border-radius: 4px; font-size: 0.75rem; color: var(--muted); transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        li:hover { color: #fff; background: #1a1a1a; }
        li.active { color: #fff; border: 1px solid var(--gold); background: #111; font-weight: bold; }
        
        main { flex: 1; display: flex; flex-direction: column; background: #050505; min-width: 0; }
        .header { padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        #search-bar { background: #111; border: 1px solid var(--gold); color: #fff; padding: 8px 12px; border-radius: 6px; width: 200px; outline: none; }
        
        .toggle-container { display: flex; background: #111; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .toggle-btn { padding: 6px 14px; border: none; background: transparent; color: var(--muted); border-radius: 6px; cursor: pointer; font-size: 0.7rem; font-weight: bold; }
        .toggle-btn.active { background: var(--gold-grad); color: #000; }

        .content { padding: 20px 30px; overflow: hidden; flex: 1; display: flex; flex-direction: column; }
        .table-wrapper { width: 100%; overflow: auto; border: 1px solid var(--border); background: #0a0a0a; border-radius: 8px; position: relative; }
        
        table { width: auto; border-collapse: separate; border-spacing: 0; }
        
        /* Fixed Header visibility */
        th { 
            position: sticky; top: 0; z-index: 30; 
            background: #050505; color: var(--gold) !important; 
            padding: 12px 15px; font-size: 0.65rem; text-transform: uppercase; 
            border-bottom: 2px solid var(--border); text-align: left;
            white-space: nowrap;
        }
        
        .sticky-song { position: sticky; left: 0; z-index: 40; min-width: 180px; background: #0f0f0f !important; border-right: 2px solid var(--border); font-weight: bold; }
        thead th.sticky-song { z-index: 50; top: 0; }

        td { padding: 12px 15px; background: #0f0f0f; border-bottom: 1px solid var(--border); font-size: 0.8rem; color: #fff; white-space: nowrap; }
        .heat-cell { color: #000 !important; font-weight: bold; text-align: center; }

        .stream-cell { color: var(--gold); font-weight: bold; cursor: help; position: relative; }
    </style>
</head>
<body>

<aside>
    <div class="brand-logo" onclick="location.reload()">THE CORE</div>
    <div class="nav-scroll"><ul id="artist-list"></ul><li onclick="clearFilter()" style="margin-top:10px; color:var(--gold)">Show All</li></div>
</aside>

<main>
    <div class="header">
        <h2 id="view-title" style="margin:0; font-size: 1.2rem;">Priority Tracks</h2>
        <div style="display:flex; gap:15px; align-items:center;">
            <input type="text" id="search-bar" placeholder="Search song..." oninput="renderTable()">
            <div class="toggle-container">
                <button id="btn-released" class="toggle-btn active" onclick="setMode('released')">RELEASED</button>
                <button id="btn-unreleased" class="toggle-btn" onclick="setMode('unreleased')">UNRELEASED</button>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="table-wrapper"><div id="table-output"></div></div>
    </div>
</main>

<script>
const MASTER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-yQVU_VNNOR5aXQ7m-Xv7BiAgYKjBfJuT6lIETy6ksjqR-Lj2WW4DNqYGCNX2rfCpUtemiS1shes/pub?gid=2070907343&single=true&output=csv';
const PRIORITY_ARTISTS = ["Anna Graves", "Bailey Zimmerman", "Baylee Lynn", "Brandon Wisham", "Cameron Whitcomb", "Dan + Shay", "Danielle Bradbery", "Dax", "Deltona", "Hannah McFarland", "Josh Ross", "Just Jayne", "Nate Smith"];
const LEGACY_EXCEPTIONS = ["Lonely Dirt Road", "Single Again", "Fix What You Didn't Break"];

let allMasterData = [];
let currentArtistFilter = null;
let currentMode = 'released';

const parseNum = (val) => parseFloat(String(val).replace(/,/g, '')) || 0;

function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('btn-' + mode).classList.add('active');
    renderTable();
}

function clearFilter() {
    currentArtistFilter = null;
    document.getElementById('view-title').innerText = "Priority Tracks";
    document.querySelectorAll('li').forEach(el => el.classList.remove('active'));
    renderTable();
}

function getTeaseHeat(teaseDateStr, relDateStr) {
    if (!teaseDateStr || !relDateStr || relDateStr.toLowerCase().includes('undecided') || relDateStr.toLowerCase().includes('tbd')) return 'background: #fff;';
    const t = new Date(teaseDateStr);
    const r = new Date(relDateStr);
    if (isNaN(t) || isNaN(r)) return 'background: #fff;';
    const diff = (r - t) / (1000 * 60 * 60 * 24);
    return diff >= 20 ? 'background: #1DB954;' : (diff < 10 ? 'background: #ff4444;' : 'background: #fff;');
}

function getFixedHeat(val, good, bad) {
    let n = parseNum(val);
    if (n >= good) return 'background: #1DB954;';
    if (n <= bad) return 'background: #ff4444;';
    return 'background: #fff;';
}

function getRelativeHeat(val, min, max) {
    let n = parseNum(val);
    if (n === 0 && min === 0) return 'background: #333; color: #fff !important;';
    if (min === max) return 'background: #fff;'; 
    const ratio = (n - min) / (max - min || 1);
    let r, g, b = 255;
    if (ratio < 0.5) {
        let f = ratio * 2; r = 255; g = Math.floor(f * 255); b = Math.floor(f * 255);
    } else {
        let f = (ratio - 0.5) * 2; r = Math.floor((1 - f) * 255); g = 255; b = Math.floor((1 - f) * 255);
    }
    return `background: rgb(${r},${g},${b});`;
}

function renderTable() {
    const searchTerm = document.getElementById('search-bar').value.toLowerCase();
    const today = new Date();
    today.setHours(0,0,0,0);

    let visibleSongs = allMasterData.filter(row => {
        const artist = (row[0] || "").trim();
        const song = (row[1] || "").trim();
        const dateStr = (row[3] || "").trim();
        const relDate = new Date(dateStr);
        const isTBD = dateStr.toLowerCase().includes('tbd') || dateStr.toLowerCase().includes('undecided') || dateStr === "";
        const isLegacyException = LEGACY_EXCEPTIONS.some(ex => song.toLowerCase().includes(ex.toLowerCase()));

        // YEAR FILTER Logic
        if (!isTBD && !isNaN(relDate)) {
            const releaseYear = relDate.getFullYear();
            if (releaseYear <= 2024 && !isLegacyException) return false;
        }

        if (!PRIORITY_ARTISTS.includes(artist)) return false;

        // TAB Logic
        if (currentMode === 'released') {
            if (isTBD || isNaN(relDate) || relDate > today) return false;
        } else {
            if (!isTBD && relDate <= today) return false;
        }

        return (currentArtistFilter ? artist === currentArtistFilter : true) && song.toLowerCase().includes(searchTerm);
    });

    const globalUGC = { min: Math.min(...visibleSongs.map(r => parseNum(r[36]))), max: Math.max(...visibleSongs.map(r => parseNum(r[36]))) };

    let headers = `<tr><th class="sticky-song">Song</th><th>Artist</th><th class="heat-cell">1st Tease</th><th>Rel Date</th>`;
    if (currentMode === 'released') {
        headers += `<th class="heat-cell">Pre-Rel Posts</th><th class="heat-cell">1st Wk Str</th><th class="heat-cell">Post-Rel Posts</th><th>Curr Streams</th><th class="heat-cell">Avg Wk Str</th><th class="heat-cell">Total Posts</th><th class="heat-cell">Total UGC</th></tr>`;
    } else {
        headers += `<th class="heat-cell">Pre-Rel Posts</th><th class="heat-cell">Total Posts</th><th class="heat-cell">Total UGC</th></tr>`;
    }

    let html = `<table><thead>${headers}</thead><tbody>`;

    visibleSongs.forEach(row => {
        const artistVisible = visibleSongs.filter(r => r[0] === row[0]);
        const artist1stWk = { min: Math.min(...artistVisible.map(r => parseNum(r[6]))), max: Math.max(...artistVisible.map(r => parseNum(r[6]))) };
        const artistAvgWk = { min: Math.min(...artistVisible.map(r => parseNum(r[9]))), max: Math.max(...artistVisible.map(r => parseNum(r[9]))) };

        let rowData = `<td class="sticky-song">${row[1]}</td><td>${row[0]}</td><td class="heat-cell" style="${getTeaseHeat(row[2], row[3])}">${row[2] || '-'}</td><td style="color:var(--gold); font-weight:bold;">${row[3] || 'TBD'}</td>`;

        if (currentMode === 'released') {
            rowData += `
                <td class="heat-cell" style="${getFixedHeat(row[40], 20, 10)}">${row[40] || '0'}</td>
                <td class="heat-cell" style="${getRelativeHeat(row[6], artist1stWk.min, artist1stWk.max)}">${row[6] || '0'}</td>
                <td class="heat-cell" style="${getFixedHeat(row[41], 20, 15)}">${row[41] || '0'}</td>
                <td class="stream-cell">${row[7] || '0'}</td>
                <td class="heat-cell" style="${getRelativeHeat(row[9], artistAvgWk.min, artistAvgWk.max)}">${row[9] || '0'}</td>
                <td class="heat-cell" style="${getFixedHeat(row[42], 40, 20)}">${row[42] || '0'}</td>
                <td class="heat-cell" style="${getRelativeHeat(row[36], globalUGC.min, globalUGC.max)}">${row[36] || '0'}</td>`;
        } else {
            rowData += `
                <td class="heat-cell" style="${getFixedHeat(row[40], 20, 10)}">${row[40] || '0'}</td>
                <td class="heat-cell" style="${getFixedHeat(row[42], 40, 20)}">${row[42] || '0'}</td>
                <td class="heat-cell" style="${getRelativeHeat(row[36], globalUGC.min, globalUGC.max)}">${row[36] || '0'}</td>`;
        }
        html += `<tr>${rowData}</tr>`;
    });
    document.getElementById('table-output').innerHTML = html + `</tbody></table>`;
}

function init() {
    Papa.parse(MASTER_CSV_URL, {
        download: true, header: false,
        complete: (results) => {
            allMasterData = results.data.filter(r => r[0] && r[0] !== "ARTIST");
            const list = document.getElementById('artist-list');
            PRIORITY_ARTISTS.sort().forEach(name => {
                const li = document.createElement('li');
                li.innerText = name;
                li.onclick = () => {
                    document.querySelectorAll('li').forEach(el => el.classList.remove('active'));
                    li.classList.add('active');
                    currentArtistFilter = name;
                    document.getElementById('view-title').innerText = name;
                    renderTable();
                };
                list.appendChild(li);
            });
            renderTable();
        }
    });
}
init();
</script>
</body>
</html>
